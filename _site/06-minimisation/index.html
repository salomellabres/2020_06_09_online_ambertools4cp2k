















<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2020-06-09 11:46:46 +0100">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/syntax.css" />

    



    <!-- Favicons for everyone -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="../assets/favicons//apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/favicons//apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/favicons//apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/favicons//apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="../assets/favicons//apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="../assets/favicons//apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="../assets/favicons//apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../assets/favicons//apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="../assets/favicons//favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="../assets/favicons//favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="../assets/favicons//favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="../assets/favicons//favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="../assets/favicons//favicon-128.png" sizes="128x128" />
    <meta name="application-name" content=" - Preparing to run biomolecular QM/MM simulations with CP2K using AmberTools"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="../assets/favicons//mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="../assets/favicons//mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="../assets/favicons//mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="../assets/favicons//mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="../assets/favicons//mstile-310x310.png" />


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->

  <title>
  Energy minimisation &ndash; Preparing to run biomolecular QM/MM simulations with CP2K using AmberTools
  </title>  

  </head>
  <body>

    



    <div class="container">
      






<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      

      
      <a class="navbar-brand" href="../">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="../CODE_OF_CONDUCT.html">Code of Conduct</a></li>

        
	
        <li><a href="../setup.html">Setup</a></li>

        
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../01-overview/index.html">Overview of AmberTools20</a></li>
            
            <li><a href="../02-setup/index.html">Log in and environment set up in ARCHER</a></li>
            
            <li><a href="../03-prepPDB/index.html">Preparing your PDB file</a></li>
            
            <li><a href="../04-parameters/index.html">Parameterising your ligands</a></li>
            
            <li><a href="../05-leap/index.html">System set up</a></li>
            
            <li><a href="../06-minimisation/index.html">Energy minimisation</a></li>
            
            <li><a href="../07-therm/index.html">Thermalisation and Density equilibration</a></li>
            
            <li><a href="../08-parmed/index.html">Adding missing LJ parameters and recentering coordinates</a></li>
            
            <li><a href="../09-qmmm/index.html">QM/MM monitorisation runs</a></li>
            
	    <li role="separator" class="divider"></li>
            <li><a href="../aio.html">All in one page (Beta)</a></li>
          </ul>
        </li>
	

	
	
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Extras <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../reference.html">Reference</a></li>
            
            <li><a href="../amber/index.html">Amber Input Files</a></li>
            
            <li><a href="../cp2k/index.html">CP2K Input Files</a></li>
            
          </ul>
        </li>
	

	
        <li><a href="../LICENSE.html">License</a></li>
	
	<li><a href="/edit//_episodes/06-minimisation.md" data-checker-ignore>Improve this page <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a></li>
	
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>

















<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../05-leap/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
    <h3 class="maintitle"><a href="../">Preparing to run biomolecular QM/MM simulations with CP2K using AmberTools</a></h3>
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../07-therm/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>

<article>
<div class="row">
  <div class="col-md-1">
  </div>
  <div class="col-md-10">
    <h1 class="maintitle">Energy minimisation</h1>
  </div>
  <div class="col-md-1">
  </div>
</div>


<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 10 min
      <br/>
      <strong>Exercises:</strong> 0 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>What should I do after generating my systemâ€™s topology and coordinates?</p>
</li>
	
	<li><p>How do I refine and remove bad contacts from the initial structure?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Run a <code class="language-plaintext highlighter-rouge">sander</code> command to minimise the initial structure.</p>
</li>
	
	<li><p>Explain briefly the options in the sander input file.</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<p>Before running any QM/MM simulation, we must <strong>ALWAYS</strong> equilibrate the system using only molecular mechanics (MM). This step will take approx. 20 min, so we are going to submit the calculation NOW on the short queue of ARCHER using the following script:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>qsub send_mm_equil.pbs
</code></pre></div></div>

<p>We are going to minimise and equilibrate the system using the <code class="language-plaintext highlighter-rouge">sander</code> tool from AmberTools suite. We have provided commented input files and ARCHER submission scripts to make these steps easier to follow. You can find more information on the sander input options in <a href="https://ambermd.org/doc12/Amber20.pdf">Chapter 19</a> of the Amber20 manual.</p>

<p>To run <code class="language-plaintext highlighter-rouge">sander</code>, one needs to specify at least the initial coordinates (<code class="language-plaintext highlighter-rouge">-c system.rst7</code>) and the topology files of your system (<code class="language-plaintext highlighter-rouge">-p system.parm7</code>) and an input file (<code class="language-plaintext highlighter-rouge">-i sander_min.in</code>) providing the details of the simuilation to perform. Also, we can specify the name of output files such the log file (<code class="language-plaintext highlighter-rouge">-o</code>) and final coordinates (<code class="language-plaintext highlighter-rouge">-r</code>).</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash --login
#PBS -N MM_equil

# Select 1 nodes (maximum of 24 cores)
#PBS -q short
#PBS -l select=2
#PBS -l walltime=00:20:00

# Make sure you change this to your budget code
#PBS -A y14-amber2020

module swap PrgEnv-cray PrgEnv-gnu
module load amber-tools/20

# Move to directory that script was submitted from
export PBS_O_WORKDIR=$(readlink -f $PBS_O_WORKDIR)
cd $PBS_O_WORKDIR

date
echo "Minimisation"
aprun -n 8 sander.MPI -O -i sander_min.in -o min_classical.out -p system.parm7 -c system.rst7 -r system.min.rst7
date
echo "Thermalisation"
aprun -n 48 sander.MPI -O -i sander_heat.in -o heat_classical.out -p system.parm7 -c system.min.rst7 -r system.heat.rst7 -x system.heat.nc
date
echo "Pressure equilibration"
aprun -n 48 sander.MPI -O -i sander_equil.in -o equil_classical.out -p system.parm7 -c system.heat.rst7 -r system.equil.rst7 -x system.equil.nc
date
</code></pre></div></div>

<hr />

<h2 id="energy-minimisation-with-sander">Energy minimisation with <code class="language-plaintext highlighter-rouge">sander</code></h2>

<p>We have devised a minimisation protocol that will perform 4000 steps using two different methods: 2000 of <a href="https://en.wikipedia.org/wiki/Gradient_descent">gradient descent</a> and 2000 of <a href="https://en.wikipedia.org/wiki/Conjugate_gradient_method">conjugate gradient</a>. The sander input file looks like this:</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Minimisation of system 
 &amp;cntrl
  imin=1,        ! Perform an energy minimization.
  maxcyc=4000,   ! The maximum number of cycles of minimization. 
  ncyc=2000,     ! The method will be switched from steepest descent to conjugate gradient after NCYC cycles.
 /
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">sander</code> should have produced the following files:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">min_classical.out</code> where it has written down the energy of the system every 50 steps.</li>
  <li><code class="language-plaintext highlighter-rouge">system.min.rst7</code> with the minimised coordinates.</li>
</ul>

<p>If we open the <code class="language-plaintext highlighter-rouge">min_classical.out</code> file, the last step of the minimisation should look like this:</p>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   NSTEP       ENERGY          RMS            GMAX         NAME    NUMBER
   4000      -1.7025E+05     2.0459E-01     9.4107E+00     OE1       169

 BOND    =    13362.4614  ANGLE   =      412.0010  DIHED      =     2157.5043
 VDWAALS =    34829.2930  EEL     =  -229750.9423  HBOND      =        0.0000
 1-4 VDW =      587.3195  1-4 EEL =     8150.8146  RESTRAINT  =        0.0000
</code></pre></div></div>

<p>We want the system to relax, so the <code class="language-plaintext highlighter-rouge">ENERGY</code> will decrease along the energy minimisation but we should also take the <code class="language-plaintext highlighter-rouge">GMAX</code> value into account. The <code class="language-plaintext highlighter-rouge">GMAX</code> is the slope on the Potential Energy Surface (PES) of the system of the current coordinates. <code class="language-plaintext highlighter-rouge">GMAX</code> should be close to 0. Other important information is the <code class="language-plaintext highlighter-rouge">NAME</code> and <code class="language-plaintext highlighter-rouge">NUMBER</code>, they point to the atom name and index, that is causing the major energy contribution.</p>



<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>After adding water molecules and combining coordinates of different system elements we have to minimise the system to fix any bad contacts (LEap had warned us already of some bad contacts in the structure).</p>
</li>
    
    <li><p>Removing bad contacts at this point will prevent our system from failing catastrophically later down the line.</p>
</li>
    
    <li><p>Combining different minimisation methods is a good practice and can help to avoid getting stuck into a local minima.</p>
</li>
    
  </ul>
</blockquote>

</article>
















<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../05-leap/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../07-therm/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>


      
      






<footer>
  <div class="row">
    <div class="col-md-6 copyright" align="left">
	
    </div>
    <div class="col-md-6 help-links" align="right">
	
	<a href="/edit//_episodes/06-minimisation.md" data-checker-ignore>Edit on GitHub</a>
	
	/
	<a href="/blob//CONTRIBUTING.md" data-checker-ignore>Contributing</a>
	/
	<a href="/">Source</a>
	/
	<a href="/blob//CITATION" data-checker-ignore>Cite</a>
	/
	<a href="mailto:s.llabres@epcc.ed.ac.uk">Contact</a>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12" align="center">
      Using <a href="https://github.com/carpentries/styles/">The Carpentries style</a>
      version <a href="https://github.com/carpentries/styles/releases/tag/v9.5.3">9.5.3</a>.
    </div>
  </div>
</footer>

      
    </div>
    
<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-37305346-2', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
